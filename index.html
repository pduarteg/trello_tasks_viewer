<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VISOR DE TAREAS</title>
  <style>
      :root {
           --bg:#0b1020;
           --card:#121a2b;
           --text:#e6e8ee;
           --muted:#9ba3b4;
           --accent:#4ea1ff;
      }
       html, body {
           margin:0;
           padding:0;
           background:var(--bg);
           color:var(--text);
           font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      }
       .wrap {
           max-width: 1100px;
           margin: 24px auto;
           padding: 0 16px;
      }
       h1 {
           font-size: 20px;
           margin: 0 0 12px;
           font-weight: 700;
      }
       .panel {
           background: var(--card);
           border: 1px solid rgba(255,255,255,.06);
           border-radius: 14px;
           padding: 14px;
      }
       .row {
           display:flex;
           gap:12px;
           flex-wrap: wrap;
           align-items: center;
      }
       input[type="file"] {
           color: var(--muted);
      }
       textarea {
           width: 100%;
           min-height: 120px;
           background:#0d1426;
           color:var(--text);
           border:1px solid rgba(255,255,255,.08);
           border-radius: 10px;
           padding:10px;
           font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      }
       button {
           background: var(--accent);
           color: #081120;
           border: none;
           padding: 10px 14px;
           border-radius: 10px;
           cursor: pointer;
           font-weight: 700;
      }
       button:disabled{
           opacity:.5;
           cursor:not-allowed;
      }
       .hint {
           color: var(--muted);
           font-size: 12px;
      }
       .table-wrap {
           margin-top:16px;
           overflow:auto;
           border-radius: 12px;
           border: 1px solid rgba(255,255,255,.06);
      }
       table {
           width:100%;
           border-collapse: collapse;
           background: #0e172b;
      }
       th, td {
           text-align:left;
           padding: 10px 12px;
           border-bottom: 1px solid rgba(255,255,255,.06);
           vertical-align: top;
      }
       th {
           position: sticky;
           top: 0;
           background: #0f1930;
           font-weight: 700;
      }
       tr:hover td {
           background: rgba(255,255,255,.03);
      }
       .pill {
           display:inline-block;
           padding:3px 8px;
           border-radius: 999px;
           font-size: 12px;
           border:1px solid rgba(255,255,255,.12);
           color:var(--muted);
      }
       .ok {
           color:#00d07f;
           border-color: #00d07f33;
      }
       .warn {
           color:#ffd166;
           border-color:#ffd16644;
      }
       .danger {
           color:#ff6b6b;
           border-color:#ff6b6b44;
      }
       a {
           color: var(--accent);
           text-decoration: none;
      }
       .toolbar {
           display:flex;
           gap:8px;
           align-items:center;
           margin-top:8px;
      }
       .toolbar input[type="search"]{
           background:#0d1426;
           color:var(--text);
           border:1px solid rgba(255,255,255,.08);
           border-radius:10px;
           padding:8px 10px;
           min-width:240px;
      }
       .hidden {
           display:none;
      }
       footer {
           display: flex;
           align-items: center;
           justify-content: center;
           font-size: 400;
      }
       footer div {
           padding: 10px;
           font-family: "Times New Roman", Times, serif;
           border-bottom: solid 2px white;
           border-radius: 6px;
      }
      .custom-file-btn {
        display: inline-block;
        background-color: #007bff;
        color: white;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: background 0.2s ease;
      }

      .custom-file-btn:hover {
        background-color: #0056b3;
      }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Visor tipo tablas para tareas desde Trello</h1>
    <div class="panel">
      <div class="row">
        <input id="fileInput" type="file" accept=".json,application/json" hidden />
        <label for="fileInput" class="custom-file-btn">üìÇ Seleccionar archivo</label>

        <button id="loadBtn" disabled>Cargar archivo</button>
        <button id="parseTextareaBtn">Convertir archivo a tabla</button>
        <button id="downloadCsvBtn" class="hidden">Descargar CSV</button>
        <span class="hint">‚Ä¢ O pega el JSON abajo y presiona ‚ÄúParsear del √°rea de texto‚Äù.</span>
      </div>
      <div class="toolbar">
        <input id="search" type="search" placeholder="Buscar por nombre o #..." />
        <span class="hint" id="countHint"></span>
      </div>
      <textarea id="jsonArea" placeholder="Pega aqu√≠ tu JSON completo..."></textarea>
      <div class="table-wrap">
        <table id="cardsTable">
          <thead>
            <tr>
              <th style="width:70px">#</th>
              <th>Card</th>
              <th style="width:160px">Lista</th>
              <th style="width:160px">Inicio</th>
              <th style="width:160px">Vence</th>
              <th style="width:130px">Estado</th>
              <th style="width:120px">Enlace</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
const $ = (q) => document.querySelector(q);
const fileInput = $("#fileInput");
const loadBtn = $("#loadBtn");
const parseTextareaBtn = $("#parseTextareaBtn");
const downloadCsvBtn = $("#downloadCsvBtn");
const jsonArea = $("#jsonArea");
const tableBody = $("#cardsTable tbody");
const searchInput = $("#search");
const countHint = $("#countHint");

let cards = []; // fuente completa
let cardsFiltered = []; // vista filtrada

function fmtDate(v) {
  if (!v) return "";
  try {
    const d = new Date(v);
    if (isNaN(d)) return "";
    const pad = (n) => String(n).padStart(2, "0");
    return d.getFullYear() + "-" + pad(d.getMonth()+1) + "-" + pad(d.getDate()) + " " +
           pad(d.getHours()) + ":" + pad(d.getMinutes());
  } catch { return ""; }
}

function statusOf(card) {
  if (card.dueComplete || card.dateCompleted) return ["Completada", "ok"];
  const now = Date.now();
  const dueMs = card.due ? Date.parse(card.due) : null;
  if (dueMs) {
    if (dueMs < now) return ["Vencida", "danger"];
    return ["Pendiente", "warn"];
  }
  return ["Sin fecha", ""];
}

function esc(s) {
  return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
}

function buildRows(list) {
  tableBody.innerHTML = list.map(c => {
    const [label, cls] = statusOf(c);
    const link = c.shortLink ? `https://trello.com/c/${c.shortLink}` : "";
    return `<tr>
      <td><span class="pill">${esc(c.idShort ?? "")}</span></td>
      <td>${esc(c.name ?? "")}</td>
      <td>${esc(c.list ?? "")}</td>
      <td>${esc(fmtDate(c.start))}</td>
      <td>${esc(fmtDate(c.due))}</td>
      <td>${label ? `<span class="pill ${cls}">${label}</span>` : ""}</td>
      <td>${link ? `<a href="${esc(link)}" target="_blank" rel="noopener">Ver</a>` : ""}</td>
    </tr>`;
  }).join("");
  countHint.textContent = list.length ? `${list.length} cards` : "";
  downloadCsvBtn.classList.toggle("hidden", list.length === 0);
}

function toCsv(list) {
  const headers = ["idShort","name","list","start","due","status","shortLink"];
  const rows = list.map(c => {
    const [label] = statusOf(c);
    return [
      c.idShort ?? "",
      c.name ?? "",
      c.list ?? "",
      fmtDate(c.start),
      fmtDate(c.due),
      label ?? "",
      c.shortLink ? `https://trello.com/c/${c.shortLink}` : ""
    ].map(v => `"${String(v).replace(/"/g,'""')}"`).join(",");
  });
  return headers.join(",") + "\n" + rows.join("\n");
}

function applySearch() {
  const q = searchInput.value.trim().toLowerCase();
  if (!q) {
    cardsFiltered = cards.slice();
  } else {
    cardsFiltered = cards.filter(c => 
      String(c.idShort ?? "").toLowerCase().includes(q) ||
      String(c.name ?? "").toLowerCase().includes(q)
    );
  }
  buildRows(cardsFiltered);
}

searchInput.addEventListener("input", applySearch);

function parseJson(raw) {
  let obj;
  try { obj = JSON.parse(raw); } catch (e) {
    alert("JSON inv√°lido: " + e.message);
    return;
  }
  // Soporte para estructura Trello 'actions' o un array de cards directo
  const actions = Array.isArray(obj) ? [] : (obj.actions || []);
  const cardMap = new Map();

  // 1) Si trae actions (Trello export / feed): consolidar por √∫ltima acci√≥n
  for (const a of actions) {
    const card = a?.data?.card;
    if (!card?.id) continue;
    const ts = Date.parse(a.date || 0) || 0;
    const prev = cardMap.get(card.id) || { lastTs: 0, id: card.id };

    // Actualiza por campos disponibles en la acci√≥n
    const next = { ...prev };
    next.lastTs = Math.max(prev.lastTs, ts);
    if (card.idShort != null) next.idShort = card.idShort;
    if (card.shortLink) next.shortLink = card.shortLink;
    if (card.name) next.name = card.name;
    if ("due" in card) next.due = card.due;
    if ("start" in card) next.start = card.start;
    if ("dueComplete" in card) next.dueComplete = card.dueComplete;
    if (card.dateCompleted) next.dateCompleted = card.dateCompleted;
    if (a?.data?.list?.name) next.list = a.data.list.name;
    if (a?.data?.board?.name) next.board = a.data.board.name;

    cardMap.set(card.id, next);
  }

  // 2) Si el objeto ya viniera como array de cards simples
  if (Array.isArray(obj)) {
    for (const c of obj) {
      if (!c?.id) continue;
      const ts = Date.now();
      const prev = cardMap.get(c.id) || { lastTs: 0, id: c.id };
      const next = { ...prev, lastTs: Math.max(prev.lastTs, ts) };
      for (const k of ["idShort","shortLink","name","due","start","dueComplete","dateCompleted","list","board"]) {
        if (k in c) next[k] = c[k];
      }
      cardMap.set(c.id, next);
    }
  }

  // Genera la lista final ordenada por idShort asc (o nombre)
  const result = Array.from(cardMap.values())
    .sort((a,b) => {
      const A = a.idShort ?? 1e12, B = b.idShort ?? 1e12;
      if (A !== B) return A - B;
      return String(a.name ?? "").localeCompare(String(b.name ?? ""));
    });

  cards = result;
  cardsFiltered = cards.slice();
  buildRows(cardsFiltered);
}

fileInput.addEventListener("change", () => {
  loadBtn.disabled = !fileInput.files?.length;
});

loadBtn.addEventListener("click", async () => {
  if (!fileInput.files?.length) return;
  const file = fileInput.files[0];
  const text = await file.text();
  jsonArea.value = text;
  parseJson(text);
});

parseTextareaBtn.addEventListener("click", () => {
  const raw = jsonArea.value.trim();
  if (!raw) {
    alert("Pega el JSON en el √°rea de texto o elige un archivo.");
    return;
  }
  parseJson(raw);
});

downloadCsvBtn.addEventListener("click", () => {
  const csv = toCsv(cardsFiltered);
  const blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "cards.csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});
</script>

</body>
<footer>
  <div>Percy Duarte | 2025</div>
</footer>
</html>
